import React, { useState } from 'react';
import Card from '../common/Card';
import Button from '../common/Button';
import { useAPI } from '../../hooks/useAPI';
import {
  generateExcelFile,
  generateCSVFile,
  generatePDFFile,
  generateWordFile,
  downloadFile,
  generateFilename,
  type ProjectExportData
} from '../../utils/exportGenerator';

interface ExportOptions {
  format: 'excel' | 'pdf' | 'word' | 'csv';
  includeCharts?: boolean;
  includeProgress?: boolean;
  includeRanking?: boolean;
  includeConsistency?: boolean;
  includeDetails?: boolean;
  includeSensitivity?: boolean;
  customTitle: string;
  logoUrl?: string;
}

interface ExportData {
  projectInfo: any;
  evaluationProgress: any[];
  rankings: any[];
  consistencyData: any[];
  treeModel: any;
  sensitivityResults?: any[];
}

interface ExportManagerProps {
  projectId: string;
  projectData: any;
  onExportComplete?: (result: { success: boolean; downloadUrl?: string; error?: string }) => void;
}

const ExportManager: React.FC<ExportManagerProps> = ({ projectId, projectData, onExportComplete }) => {
  const [exportOptions, setExportOptions] = useState<ExportOptions>({
    format: 'excel',
    includeCharts: true,
    includeProgress: true,
    includeRanking: true,
    includeConsistency: true,
    includeDetails: true,
    includeSensitivity: false,
    customTitle: 'AHP Î∂ÑÏÑù Í≤∞Í≥º Î≥¥Í≥†ÏÑú'
  });

  const [isExporting, setIsExporting] = useState(false);
  const [exportProgress, setExportProgress] = useState(0);
  const [previewMode, setPreviewMode] = useState(false);

  const api = useAPI();

  const formatOptions = [
    { value: 'excel', label: 'Excel (.xlsx)', icon: 'üìä', description: 'Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÌòïÌÉúÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞' },
    { value: 'pdf', label: 'PDF (.pdf)', icon: 'üìÑ', description: 'Ïù∏ÏáÑ Í∞ÄÎä•Ìïú PDF Î≥¥Í≥†ÏÑú' },
    { value: 'word', label: 'Word (.docx)', icon: 'üìù', description: 'Ìé∏Ïßë Í∞ÄÎä•Ìïú Word Î¨∏ÏÑú' },
    { value: 'csv', label: 'CSV (.csv)', icon: 'üóÇÔ∏è', description: 'Îç∞Ïù¥ÌÑ∞Îßå CSV ÌòïÌÉúÎ°ú' }
  ];

  const updateExportOption = (key: keyof ExportOptions, value: any) => {
    setExportOptions(prev => ({ ...prev, [key]: value }));
  };

  const generatePreview = () => {
    if (!projectData) {
      alert('ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
      return;
    }

    // ÎØ∏Î¶¨Î≥¥Í∏∞ Î™®Îã¨ ÎòêÎäî ÏÉà Ï∞ΩÏóêÏÑú ÌîÑÎ¶¨Î∑∞ ÌëúÏãú
    const previewData = {
      projectTitle: projectData.title || 'Ï†úÎ™© ÏóÜÏùå',
      criteriaCount: projectData.criteria?.length || 0,
      alternativesCount: projectData.alternatives?.length || 0,
      format: exportOptions.format,
      options: exportOptions
    };

    const previewText = `
üìä ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÎØ∏Î¶¨Î≥¥Í∏∞

ÌîÑÎ°úÏ†ùÌä∏: ${previewData.projectTitle}
ÌòïÏãù: ${formatOptions.find(f => f.value === exportOptions.format)?.label}
Í∏∞Ï§Ä Ïàò: ${previewData.criteriaCount}Í∞ú
ÎåÄÏïà Ïàò: ${previewData.alternativesCount}Í∞ú

Ìè¨Ìï® ÎÇ¥Ïö©:
${exportOptions.includeProgress ? '‚úÖ ÌèâÍ∞Ä ÏßÑÌñâ ÏÉÅÌô©\n' : ''}
${exportOptions.includeRanking ? '‚úÖ ÏàúÏúÑ Î∞è Í≤∞Í≥º\n' : ''}
${exportOptions.includeConsistency ? '‚úÖ ÏùºÍ¥ÄÏÑ± Î∂ÑÏÑù\n' : ''}
${exportOptions.includeDetails ? '‚úÖ ÏÑ∏Î∂Ä Î∂ÑÏÑù ÎÇ¥Ïö©\n' : ''}
${exportOptions.includeCharts ? '‚úÖ Ï∞®Ìä∏ Î∞è Í∑∏ÎûòÌîÑ\n' : ''}
${exportOptions.includeSensitivity ? '‚úÖ ÎØºÍ∞êÎèÑ Î∂ÑÏÑù\n' : ''}

Ïù¥ ÎÇ¥Ïö©ÏúºÎ°ú ÌååÏùºÏùÑ ÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?
    `;

    if (confirm(previewText.trim())) {
      handleExport();
    }
  };

  const handleExport = async () => {
    try {
      setIsExporting(true);
      setExportProgress(10);

      // 1Îã®Í≥Ñ: Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
      await new Promise(resolve => setTimeout(resolve, 300));
      setExportProgress(30);

      const exportData: ProjectExportData = {
        id: projectId,
        title: projectData?.title || 'Ï†úÎ™© ÏóÜÏùå',
        description: projectData?.description || '',
        status: projectData?.status || 'active',
        createdAt: projectData?.createdAt || new Date().toISOString(),
        updatedAt: projectData?.updatedAt || new Date().toISOString(),
        criteria: projectData?.criteria || [],
        alternatives: projectData?.alternatives || [],
        evaluations: projectData?.evaluations || [],
        results: projectData?.results || {},
        consistency: projectData?.consistency || {}
      };

      // 2Îã®Í≥Ñ: ÌååÏùº ÏÉùÏÑ±
      await new Promise(resolve => setTimeout(resolve, 500));
      setExportProgress(60);

      let fileBlob: Blob;
      let fileExtension: string;

      switch (exportOptions.format) {
        case 'excel':
          fileBlob = generateExcelFile(exportData, exportOptions);
          fileExtension = 'xlsx';
          break;
        case 'csv':
          fileBlob = generateCSVFile(exportData, exportOptions);
          fileExtension = 'csv';
          break;
        case 'pdf':
          fileBlob = generatePDFFile(exportData, exportOptions);
          fileExtension = 'html'; // PDF Î≥ÄÌôòÏùÄ Î≥ÑÎèÑ ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌïÑÏöî
          break;
        case 'word':
          fileBlob = generateWordFile(exportData, exportOptions);
          fileExtension = 'doc';
          break;
        default:
          throw new Error(`ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÌòïÏãù: ${exportOptions.format}`);
      }

      // 3Îã®Í≥Ñ: Îã§Ïö¥Î°úÎìú
      await new Promise(resolve => setTimeout(resolve, 300));
      setExportProgress(90);

      const filename = generateFilename(projectId, exportData.title, fileExtension);
      downloadFile(fileBlob, filename);

      // ÏôÑÎ£å
      setExportProgress(100);
      await new Promise(resolve => setTimeout(resolve, 200));

      onExportComplete?.({ 
        success: true, 
        downloadUrl: filename
      });

    } catch (error) {
      console.error('Export error:', error);
      onExportComplete?.({ 
        success: false, 
        error: error instanceof Error ? error.message : 'ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ïã§Ìå®'
      });
    } finally {
      setTimeout(() => {
        setIsExporting(false);
        setExportProgress(0);
      }, 1000);
    }
  };

  return (
    <div className="w-full space-y-6">
      {/* Export format selection */}
      <Card title="ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÌòïÏãù ÏÑ†ÌÉù">
        <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
          {formatOptions.map(option => (
            <div
              key={option.value}
              className={`p-4 border rounded-lg cursor-pointer transition-colors ${
                exportOptions.format === option.value
                  ? 'border-blue-500 bg-blue-50'
                  : 'border-gray-200 hover:border-gray-300'
              }`}
              onClick={() => updateExportOption('format', option.value)}
            >
              <div className="flex items-center mb-2">
                <span className="text-2xl mr-2">{option.icon}</span>
                <span className="font-medium">{option.label}</span>
              </div>
              <p className="text-sm text-gray-600">{option.description}</p>
            </div>
          ))}
        </div>
      </Card>

      {/* Export options */}
      <Card title="ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏòµÏÖò">
        <div className="space-y-4">
          {/* Title setting */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Î≥¥Í≥†ÏÑú Ï†úÎ™©
            </label>
            <input
              type="text"
              value={exportOptions.customTitle}
              onChange={(e) => updateExportOption('customTitle', e.target.value)}
              className="w-full border border-gray-300 rounded px-3 py-2"
              placeholder="Î≥¥Í≥†ÏÑú Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
            />
          </div>

          {/* Content selection */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Ìè¨Ìï®Ìï† ÎÇ¥Ïö©
            </label>
            <div className="space-y-2">
              {[
                { key: 'includeProgress', label: 'ÌèâÍ∞Ä ÏßÑÌñâ ÏÉÅÌô©' },
                { key: 'includeRanking', label: 'ÏàúÏúÑ Î∞è Í≤∞Í≥º' },
                { key: 'includeConsistency', label: 'ÏùºÍ¥ÄÏÑ± Î∂ÑÏÑù' },
                { key: 'includeDetails', label: 'ÏÑ∏Î∂Ä Î∂ÑÏÑù ÎÇ¥Ïö©' },
                { key: 'includeCharts', label: 'Ï∞®Ìä∏ Î∞è Í∑∏ÎûòÌîÑ' },
                { key: 'includeSensitivity', label: 'ÎØºÍ∞êÎèÑ Î∂ÑÏÑù' }
              ].map(({ key, label }) => (
                <label key={key} className="flex items-center">
                  <input
                    type="checkbox"
                    checked={Boolean(exportOptions[key as keyof ExportOptions])}
                    onChange={(e) => updateExportOption(key as keyof ExportOptions, e.target.checked)}
                    className="mr-2"
                  />
                  <span className="text-sm">{label}</span>
                </label>
              ))}
            </div>
          </div>

          {/* Logo URL (optional) */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              ÌöåÏÇ¨ Î°úÍ≥† URL (ÏÑ†ÌÉùÏÇ¨Ìï≠)
            </label>
            <input
              type="url"
              value={exportOptions.logoUrl || ''}
              onChange={(e) => updateExportOption('logoUrl', e.target.value)}
              className="w-full border border-gray-300 rounded px-3 py-2"
              placeholder="https://example.com/logo.png"
            />
          </div>
        </div>
      </Card>

      {/* Action buttons */}
      <div className="flex space-x-4">
        <Button
          onClick={generatePreview}
          variant="secondary"
          disabled={isExporting || !projectData}
        >
          {!projectData ? 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå' : 'ÎØ∏Î¶¨Î≥¥Í∏∞'}
        </Button>

        <Button
          onClick={handleExport}
          variant="primary"
          disabled={isExporting || !projectData || !exportOptions.customTitle.trim()}
        >
          {isExporting ? 
            `ÎÇ¥Î≥¥ÎÇ¥Îäî Ï§ë... (${exportProgress}%)` : 
            !projectData ? 'Îç∞Ïù¥ÌÑ∞ ÌïÑÏöî' :
            !exportOptions.customTitle.trim() ? 'Ï†úÎ™© ÏûÖÎ†• ÌïÑÏöî' :
            'ÎÇ¥Î≥¥ÎÇ¥Í∏∞'
          }
        </Button>
        
        {/* Îπ†Î•∏ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Î≤ÑÌäºÎì§ */}
        <div className="flex space-x-2 ml-4">
          <button
            onClick={() => { updateExportOption('format', 'excel'); setTimeout(handleExport, 100); }}
            disabled={isExporting || !projectData}
            className="px-3 py-2 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 disabled:opacity-50 disabled:cursor-not-allowed"
            title="ExcelÎ°ú Îπ†Î•∏ ÎÇ¥Î≥¥ÎÇ¥Í∏∞"
          >
            üìä Excel
          </button>
          <button
            onClick={() => { updateExportOption('format', 'csv'); setTimeout(handleExport, 100); }}
            disabled={isExporting || !projectData}
            className="px-3 py-2 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 disabled:opacity-50 disabled:cursor-not-allowed"
            title="CSVÎ°ú Îπ†Î•∏ ÎÇ¥Î≥¥ÎÇ¥Í∏∞"
          >
            üóÇÔ∏è CSV
          </button>
        </div>
      </div>

      {/* Progress display */}
      {isExporting && (
        <Card title="ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏßÑÌñâÎ•†">
          <div className="space-y-3">
            <div className="flex justify-between text-sm">
              <span className="font-medium">
                {exportProgress < 30 ? 'Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ Ï§ë...' :
                 exportProgress < 60 ? 'ÌååÏùº ÏÉùÏÑ± Ï§ë...' :
                 exportProgress < 90 ? 'Îã§Ïö¥Î°úÎìú Ï§ÄÎπÑ Ï§ë...' : 'ÏôÑÎ£å!'}
              </span>
              <span className="font-bold text-blue-600">{exportProgress}%</span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-3">
              <div
                className="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-500 ease-out"
                style={{ width: `${exportProgress}%` }}
              ></div>
            </div>
            <div className="text-xs text-gray-600 text-center">
              ÌååÏùº ÌòïÏãù: {formatOptions.find(f => f.value === exportOptions.format)?.label}
            </div>
          </div>
        </Card>
      )}

      {/* Help text */}
      <Card title="ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏïàÎÇ¥ÏÇ¨Ìï≠">
        <div className="space-y-2 text-sm text-gray-600">
          <p>‚Ä¢ <strong>Excel:</strong> Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Î∞è Ï∂îÍ∞Ä Í∞ÄÍ≥µÏóê Ï†ÅÌï©Ìï©ÎãàÎã§.</p>
          <p>‚Ä¢ <strong>PDF:</strong> Ïù∏ÏáÑ Î∞è Í≥µÏú†Ïö© ÏµúÏ¢Ö Î≥¥Í≥†ÏÑúÎ°ú Ï†ÅÌï©Ìï©ÎãàÎã§.</p>
          <p>‚Ä¢ <strong>Word:</strong> Î≥¥Í≥†ÏÑú Ìé∏Ïßë Î∞è Ï∂îÍ∞Ä ÏûëÏÑ±Ïóê Ï†ÅÌï©Ìï©ÎãàÎã§.</p>
          <p>‚Ä¢ <strong>CSV:</strong> Îã§Î•∏ ÏãúÏä§ÌÖúÏúºÎ°ú Îç∞Ïù¥ÌÑ∞ Ïù¥Ï†Ñ Ïãú ÏÇ¨Ïö©Ìï©ÎãàÎã§.</p>
          <p className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
            <strong>Ï∞∏Í≥†:</strong> ÎÇ¥Î≥¥ÎÇ∏ ÌååÏùºÏùÄ Í∞úÏù∏ ÎîîÎ∞îÏù¥Ïä§Ïóê Ï†ÄÏû•ÎêòÎ©∞, 
            ÏÑúÎ≤ÑÏóêÎäî Ï†ÄÏû•ÎêòÏßÄ ÏïäÏäµÎãàÎã§. Ï§ëÏöîÌïú ÏûêÎ£åÎäî ÏïàÏ†ÑÌïú Í≥≥Ïóê Î≥¥Í¥ÄÌïòÏÑ∏Ïöî.
          </p>
        </div>
      </Card>
    </div>
  );
};

export default ExportManager;