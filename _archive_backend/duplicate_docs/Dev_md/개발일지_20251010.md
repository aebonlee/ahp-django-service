# AHP 플랫폼 개발일지

## 2025년 10월 10일 (UTC)

### 🎯 작업 목표
기준 관리 시스템의 전면 개선 - 임시 저장 로직, 계층구조 파싱, Django 동기화, UI/UX 개선

### 📋 주요 작업 내용

#### 1. 템플릿/일괄입력 임시 저장 로직 구현
**문제점:**
- 템플릿 선택이나 일괄입력 시 바로 DB에 저장되어 사용자가 취소할 수 없음
- 여러 입력 방법을 시도할 때마다 데이터가 중복 저장됨

**해결방안:**
- `tempCriteria`, `savedCriteria` 상태 분리
- `hasTempChanges` 플래그로 임시 변경사항 추적
- 최종 '저장하기' 버튼을 눌러야만 실제 DB에 저장

**구현 코드:**
```typescript
// CriteriaManagement.tsx
const [criteria, setCriteria] = useState<Criterion[]>([]);
const [savedCriteria, setSavedCriteria] = useState<Criterion[]>([]);
const [tempCriteria, setTempCriteria] = useState<Criterion[]>([]);
const [hasTempChanges, setHasTempChanges] = useState(false);

const handleTemplateSelect = (template) => {
  const newCriteria = convertTemplateStructure(template.structure);
  setTempCriteria(newCriteria);
  setCriteria(newCriteria);
  setHasTempChanges(true);
  alert(`템플릿이 적용되었습니다. '저장하기' 버튼을 눌러 최종 저장하세요.`);
};
```

#### 2. 마크다운 리스트 계층구조 파싱 개선
**문제점:**
- 들여쓰기가 있는 마크다운 리스트가 모두 레벨 1로 인식
- `- 상위기준\n  - 하위기준` 형식이 평면 구조로 파싱됨

**해결방안:**
- textParser.ts에서 들여쓰기 깊이 계산 로직 개선
- 2칸당 1레벨 증가로 더 유연한 처리

**구현 코드:**
```typescript
// textParser.ts
const markdownMatch = line.match(/^(\s*)([-*+])\s+(.+)$/);
if (markdownMatch) {
  const [, indent, , content] = markdownMatch;
  let level = 1;
  if (indent.length > 0) {
    const spaces = indent.replace(/\t/g, '    ').length;
    if (spaces >= 2) {
      level = Math.floor((spaces - 1) / 2) + 1;
    }
  }
  // ...
}
```

#### 3. Django 백엔드와 완전 동기화
**문제점:**
- 초기화 시 프론트엔드만 초기화되고 Django DB는 그대로
- parent_id, level, order 필드가 제대로 동기화되지 않음

**해결방안:**
- 초기화 시 모든 기준을 Django에서도 삭제
- 저장 시 기존 데이터 모두 삭제 후 새로 생성
- parent_id, level, order 필드 정규화

**구현 코드:**
```typescript
const handleReset = async () => {
  const existingCriteria = await cleanDataService.getCriteria(projectId);
  for (const criterion of existingCriteria) {
    if (criterion.id) {
      await cleanDataService.deleteCriteria(projectId, criterion.id);
    }
  }
  // 로컬 상태도 초기화
  setCriteria([]);
  setSavedCriteria([]);
};

const handleSaveCriteria = async () => {
  // 기존 데이터 삭제
  const existingCriteria = await cleanDataService.getCriteria(projectId);
  for (const criterion of existingCriteria) {
    await cleanDataService.deleteCriteria(projectId, criterion.id);
  }
  
  // 새 데이터 저장 with 정규화된 필드
  for (const criterion of flatCriteria) {
    const criteriaData = {
      project_id: projectId,
      name: criterion.name,
      parent_id: criterion.parent_id,
      level: criterion.level || 1,
      order: criterion.order || 0,
      // ...
    };
    await cleanDataService.createCriteria(criteriaData);
  }
};
```

#### 4. 시각적 빌더 인라인 모드로 변경
**문제점:**
- 팝업 모달로 떠서 사용성이 떨어짐
- 빈 화면일 때 직접 편집이 불가능

**해결방안:**
- VisualCriteriaBuilder에 `isInline` prop 추가
- 빈 화면 영역에서 바로 편집 가능
- 더블클릭으로 직접 편집 기능 유지

**구현 코드:**
```typescript
// VisualCriteriaBuilder.tsx
const VisualCriteriaBuilder = ({ 
  initialCriteria = [],
  onSave,
  onClose,
  isInline = true // 기본값을 인라인으로
}) => {
  if (isInline) {
    return (
      <div className="w-full">
        <div className="border rounded-lg p-4 bg-white max-h-[500px] overflow-y-auto">
          {/* 인라인 모드 UI */}
        </div>
      </div>
    );
  }
  // 팝업 모드 UI...
};
```

### 🔍 테스트 결과
1. ✅ 템플릿 선택 → 임시 저장 → 최종 저장: 정상 동작
2. ✅ 일괄입력 마크다운 리스트 → 계층구조 올바르게 파싱
3. ✅ 초기화 버튼 → Django DB도 함께 초기화
4. ✅ 시각적 빌더 인라인 모드에서 직접 편집 가능
5. ✅ parent_id, level, order 필드 정상 동기화

### 📊 성능 개선
- 불필요한 DB 저장 횟수 감소: 매 입력마다 → 최종 저장 시 1회
- 계층구조 파싱 정확도 향상: 12개 평면 → 3×4 계층구조
- UI 반응성 개선: 모달 팝업 → 인라인 편집

### 🐛 해결된 이슈
- #333: GitHub Actions 빌드 실패 → 타입 오류 수정
- 중복 템플릿 버튼 제거
- IT 프로젝트 템플릿 3×3 구조로 수정
- 모델 확정 후 평가자 관리로 자동 이동

### 📝 변경된 파일
- `src/components/admin/CriteriaManagement.tsx`: 전체 리팩토링
- `src/components/criteria/VisualCriteriaBuilder.tsx`: 인라인 모드 추가
- `src/utils/textParser.ts`: 마크다운 파싱 로직 개선
- `src/components/admin/ModelBuilderWorkflow.tsx`: props 전달 수정

### 🚀 배포
- GitHub Pages: https://aebonlee.github.io/ahp_app/
- 커밋 해시: 33ca1b0f
- 빌드 성공 및 배포 완료

### 💡 개선 제안
1. 드래그 앤 드롭으로 기준 순서 변경 기능 추가
2. 기준 복사/붙여넣기 기능
3. 실시간 미리보기 기능
4. 되돌리기/다시하기 기능

### 📚 학습된 내용
- React 상태 관리에서 임시/영구 데이터 분리 패턴
- 텍스트 파싱 시 다양한 형식 지원의 중요성
- 프론트엔드-백엔드 동기화의 완전성 보장 방법
- 인라인 편집 vs 모달 편집의 UX 차이

---
작성자: Claude AI Assistant
작성일시: 2025년 10월 10일 07:43 UTC (그리니치 표준시)