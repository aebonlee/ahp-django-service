<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 Full Workflow Debug - AHP Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1200px; margin: 0 auto;
            background: white; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; padding: 2rem; text-align: center;
        }
        .content { padding: 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .section {
            background: #f8f9fa; padding: 1.5rem; border-radius: 10px;
            border: 2px solid #e0e0e0;
        }
        .section h3 {
            color: #333; margin-bottom: 1rem;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input, textarea, select {
            width: 100%; padding: 0.8rem; border: 2px solid #ddd;
            border-radius: 6px; font-size: 0.9rem;
        }
        .btn-group { display: flex; gap: 0.5rem; margin-top: 1rem; }
        button {
            flex: 1; padding: 0.8rem; border: none; border-radius: 6px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-warning { background: #ed8936; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-info { background: #4299e1; color: white; }
        button:hover { transform: translateY(-2px); }
        .console {
            background: #1a202c; color: #68d391; padding: 1rem;
            border-radius: 8px; font-family: 'Courier New', monospace;
            max-height: 400px; overflow-y: auto; font-size: 0.85rem;
            grid-column: 1 / -1; margin-top: 1rem;
        }
        .console-line { margin-bottom: 3px; white-space: pre-wrap; }
        .success { color: #68d391; }
        .error { color: #fc8181; }
        .info { color: #63b3ed; }
        .warning { color: #f6e05e; }
        .status { 
            display: inline-block; width: 10px; height: 10px; 
            border-radius: 50%; margin-right: 8px;
        }
        .status-success { background: #48bb78; }
        .status-error { background: #f56565; }
        .status-pending { background: #ed8936; }
        .response-box {
            background: #2d3748; color: #e2e8f0; padding: 1rem;
            border-radius: 6px; margin-top: 1rem; font-family: monospace;
            max-height: 200px; overflow-y: auto; font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 프론트엔드 → Django → PostgreSQL 완전 워크플로우 테스트</h1>
            <p>실시간 디버깅 및 데이터 흐름 추적</p>
        </div>
        
        <div class="content">
            <!-- 프로젝트 생성 폼 -->
            <div class="section">
                <h3>📝 프로젝트 생성 폼</h3>
                <div class="form-group">
                    <label>프로젝트 제목 *</label>
                    <input type="text" id="projectTitle" value="Debug Test Project" placeholder="프로젝트 제목">
                </div>
                <div class="form-group">
                    <label>목표 *</label>
                    <input type="text" id="projectObjective" value="Complete workflow test" placeholder="프로젝트 목표">
                </div>
                <div class="form-group">
                    <label>설명</label>
                    <textarea id="projectDescription" rows="3" placeholder="프로젝트 설명">Full workflow debugging and testing</textarea>
                </div>
                <div class="form-group">
                    <label>공개 범위</label>
                    <select id="projectVisibility">
                        <option value="private">비공개</option>
                        <option value="team">팀 공개</option>
                        <option value="public">전체 공개</option>
                    </select>
                </div>
            </div>
            
            <!-- 연결 상태 및 제어 -->
            <div class="section">
                <h3>🔧 시스템 상태 및 제어</h3>
                <div style="margin-bottom: 1rem;">
                    <div><span class="status status-pending" id="apiStatus"></span>API 서버: <span id="apiStatusText">확인 중...</span></div>
                    <div><span class="status status-pending" id="dbStatus"></span>데이터베이스: <span id="dbStatusText">확인 중...</span></div>
                    <div><span class="status status-pending" id="authStatus"></span>인증: <span id="authStatusText">확인 중...</span></div>
                </div>
                
                <div class="btn-group" style="flex-direction: column;">
                    <button class="btn-info" onclick="checkSystemStatus()">1. 시스템 상태 확인</button>
                    <button class="btn-warning" onclick="loadApiService()">2. API 서비스 로드</button>
                    <button class="btn-primary" onclick="testProjectCreation()">3. 프로젝트 생성 테스트</button>
                    <button class="btn-success" onclick="verifyDatabaseSave()">4. DB 저장 검증</button>
                    <button class="btn-danger" onclick="clearConsole()">콘솔 지우기</button>
                </div>
            </div>
            
            <!-- 실시간 응답 모니터 -->
            <div class="section">
                <h3>📡 API 응답 모니터</h3>
                <div><strong>마지막 요청:</strong> <span id="lastRequest">없음</span></div>
                <div><strong>응답 상태:</strong> <span id="responseStatus">-</span></div>
                <div><strong>응답 시간:</strong> <span id="responseTime">-</span></div>
                <div class="response-box" id="responseBox">
                    API 응답이 여기에 표시됩니다...
                </div>
            </div>
            
            <!-- 데이터베이스 상태 -->
            <div class="section">
                <h3>🗄️ PostgreSQL 데이터베이스</h3>
                <div><strong>총 프로젝트:</strong> <span id="projectCount">-</span></div>
                <div><strong>마지막 생성:</strong> <span id="lastCreated">-</span></div>
                <div><strong>데이터 상태:</strong> <span id="dataStatus">확인 중...</span></div>
                <div style="margin-top: 1rem;">
                    <button class="btn-info" onclick="refreshProjectList()" style="width: 100%;">프로젝트 목록 새로고침</button>
                </div>
                <div class="response-box" id="projectListBox" style="height: 150px;">
                    프로젝트 목록이 여기에 표시됩니다...
                </div>
            </div>
        </div>
        
        <!-- 실시간 콘솔 -->
        <div class="console" id="console">
            <div class="console-line info">[${new Date().toLocaleString()}] 🚀 전체 워크플로우 디버거 초기화 완료</div>
            <div class="console-line info">[${new Date().toLocaleString()}] 📊 Frontend → Django → PostgreSQL 데이터 흐름 추적 시작</div>
            <div class="console-line">═══════════════════════════════════════════════════════════════════</div>
        </div>
    </div>
    
    <script src="./scripts/api-service.js"></script>
    <script>
        // 전역 변수
        let apiService = null;
        let lastRequestTime = 0;
        
        // 콘솔 로그 함수
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }
        
        // 상태 업데이트 함수
        function updateStatus(element, status, text) {
            const statusEl = document.getElementById(element);
            const textEl = document.getElementById(element.replace('Status', 'StatusText'));
            statusEl.className = `status status-${status}`;
            if (textEl) textEl.textContent = text;
        }
        
        // 응답 모니터 업데이트
        function updateResponseMonitor(request, status, time, data) {
            document.getElementById('lastRequest').textContent = request;
            document.getElementById('responseStatus').textContent = status;
            document.getElementById('responseTime').textContent = time + 'ms';
            document.getElementById('responseBox').textContent = JSON.stringify(data, null, 2);
        }
        
        // 1. 시스템 상태 확인
        async function checkSystemStatus() {
            log('🔍 시스템 상태 종합 확인 시작...', 'info');
            
            // API 서버 확인
            try {
                const startTime = Date.now();
                const response = await fetch('https://ahp-django-backend.onrender.com/api/service/projects/', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                const endTime = Date.now();
                
                if (response.ok) {
                    const data = await response.json();
                    updateStatus('api', 'success', '온라인');
                    log(`✅ API 서버 연결 성공 (${endTime - startTime}ms)`, 'success');
                    updateResponseMonitor('GET /api/service/projects/', response.status, endTime - startTime, data);
                } else {
                    updateStatus('api', 'error', '오류');
                    log(`❌ API 서버 오류: ${response.status}`, 'error');
                }
            } catch (error) {
                updateStatus('api', 'error', '연결 실패');
                log(`❌ API 서버 연결 실패: ${error.message}`, 'error');
            }
            
            // 데이터베이스 상태 확인
            try {
                const response = await fetch('https://ahp-django-backend.onrender.com/api/service/health/', {
                    method: 'GET'
                });
                if (response.ok) {
                    updateStatus('db', 'success', '연결됨');
                    log('✅ PostgreSQL 데이터베이스 연결 확인', 'success');
                } else {
                    updateStatus('db', 'error', '연결 오류');
                    log('❌ 데이터베이스 상태 확인 실패', 'error');
                }
            } catch (error) {
                updateStatus('db', 'error', '확인 불가');
                log(`⚠️ DB 상태 확인 불가: ${error.message}`, 'warning');
            }
            
            log('📊 시스템 상태 확인 완료', 'info');
        }
        
        // 2. API 서비스 로드
        async function loadApiService() {
            log('📡 AHP API 서비스 로드 중...', 'info');
            
            try {
                if (typeof AHPApiService !== 'undefined') {
                    apiService = new AHPApiService();
                    window.ahpApi = apiService;
                    log('✅ API 서비스 로드 성공', 'success');
                    updateStatus('auth', 'success', '준비됨');
                    
                    // 인증 상태 확인
                    try {
                        const userResult = await apiService.getCurrentUser();
                        if (userResult.success) {
                            log(`✅ 인증된 사용자: ${userResult.user.name}`, 'success');
                            updateStatus('auth', 'success', '인증됨');
                        } else {
                            log('ℹ️ 익명 사용자로 진행', 'info');
                            updateStatus('auth', 'pending', '익명');
                        }
                    } catch (authError) {
                        log('ℹ️ 인증 상태 확인 실패, 익명으로 진행', 'info');
                        updateStatus('auth', 'pending', '익명');
                    }
                } else {
                    throw new Error('AHPApiService 클래스를 찾을 수 없습니다');
                }
            } catch (error) {
                log(`❌ API 서비스 로드 실패: ${error.message}`, 'error');
                updateStatus('auth', 'error', '실패');
            }
        }
        
        // 3. 프로젝트 생성 테스트
        async function testProjectCreation() {
            if (!apiService) {
                log('⚠️ API 서비스를 먼저 로드해주세요', 'warning');
                return;
            }
            
            const projectData = {
                title: document.getElementById('projectTitle').value + ' - ' + new Date().toLocaleTimeString(),
                objective: document.getElementById('projectObjective').value,
                description: document.getElementById('projectDescription').value,
                visibility: document.getElementById('projectVisibility').value,
                settings: {
                    evaluation_method: 'pairwise',
                    status: 'draft'
                }
            };
            
            log('🚀 프로젝트 생성 요청 전송...', 'info');
            log(`📤 요청 데이터: ${JSON.stringify(projectData, null, 2)}`, 'info');
            
            try {
                const startTime = Date.now();
                const result = await apiService.createProject(projectData);
                const endTime = Date.now();
                
                updateResponseMonitor('POST /api/service/projects/', 
                    result.success ? 'SUCCESS' : 'FAILED', 
                    endTime - startTime, 
                    result
                );
                
                if (result.success) {
                    log('✅ 프로젝트 생성 성공!', 'success');
                    log(`📋 프로젝트 ID: ${result.data?.id || 'N/A'}`, 'success');
                    log(`📊 제목: ${result.data?.title || projectData.title}`, 'success');
                    log('🔄 데이터베이스 저장 검증을 진행하세요', 'info');
                    
                    // 자동으로 DB 검증 실행
                    setTimeout(verifyDatabaseSave, 1000);
                } else {
                    log(`❌ 프로젝트 생성 실패: ${result.message}`, 'error');
                    log(`💭 오류 상세: ${result.error || '알 수 없음'}`, 'error');
                }
            } catch (error) {
                log(`❌ 프로젝트 생성 예외: ${error.message}`, 'error');
                updateResponseMonitor('POST /api/service/projects/', 'EXCEPTION', 0, { error: error.message });
            }
        }
        
        // 4. 데이터베이스 저장 검증
        async function verifyDatabaseSave() {
            log('🔍 PostgreSQL 데이터베이스 저장 검증 중...', 'info');
            
            try {
                const response = await fetch('https://ahp-django-backend.onrender.com/api/service/projects/');
                if (response.ok) {
                    const data = await response.json();
                    const projectCount = data.results ? data.results.length : data.length || 0;
                    
                    document.getElementById('projectCount').textContent = projectCount;
                    document.getElementById('dataStatus').textContent = '저장 확인됨';
                    document.getElementById('projectListBox').textContent = JSON.stringify(data, null, 2);
                    
                    if (projectCount > 0) {
                        const latest = data.results ? data.results[0] : data[0];
                        document.getElementById('lastCreated').textContent = latest?.title || 'N/A';
                        log(`✅ 데이터베이스에 ${projectCount}개 프로젝트 저장 확인`, 'success');
                        log(`📋 최신 프로젝트: ${latest?.title || 'N/A'}`, 'success');
                    } else {
                        log('⚠️ 데이터베이스에 저장된 프로젝트가 없습니다', 'warning');
                    }
                } else {
                    log(`❌ 데이터베이스 조회 실패: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`❌ 데이터베이스 검증 오류: ${error.message}`, 'error');
            }
        }
        
        // 프로젝트 목록 새로고침
        async function refreshProjectList() {
            await verifyDatabaseSave();
        }
        
        // 콘솔 지우기
        function clearConsole() {
            const console = document.getElementById('console');
            console.innerHTML = `
                <div class="console-line info">[${new Date().toLocaleTimeString()}] 🧹 콘솔 초기화됨</div>
                <div class="console-line">═══════════════════════════════════════════════════════════════════</div>
            `;
        }
        
        // 페이지 로드 시 자동 실행
        window.addEventListener('load', () => {
            log('💡 팁: 버튼을 순서대로 클릭하여 전체 워크플로우를 테스트하세요', 'info');
            log('📋 단계: 1) 시스템 상태 → 2) API 로드 → 3) 프로젝트 생성 → 4) DB 검증', 'info');
            
            // 5초 후 자동으로 시스템 상태 확인
            setTimeout(checkSystemStatus, 2000);
        });
    </script>
</body>
</html>