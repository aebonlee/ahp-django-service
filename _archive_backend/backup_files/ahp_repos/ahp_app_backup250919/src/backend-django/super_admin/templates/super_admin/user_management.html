{% extends 'super_admin/base.html' %}

{% block title %}회원 관리 - AHP Platform 총 관리자{% endblock %}

{% block page_title %}회원 관리{% endblock %}

{% block content %}
<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">검색</label>
                        <input type="text" class="form-control" name="search" 
                               value="{{ request.GET.search }}" 
                               placeholder="이메일, 이름, 조직명으로 검색">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">사용자 유형</label>
                        <select class="form-select" name="user_type">
                            <option value="">전체</option>
                            {% for value, display in user_types %}
                                <option value="{{ value }}" 
                                        {% if request.GET.user_type == value %}selected{% endif %}>
                                    {{ display }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">구독 티어</label>
                        <select class="form-select" name="subscription_tier">
                            <option value="">전체</option>
                            {% for value, display in subscription_tiers %}
                                <option value="{{ value }}" 
                                        {% if request.GET.subscription_tier == value %}selected{% endif %}>
                                    {{ display }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> 검색
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <a href="{% url 'super_admin:user_management' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-refresh"></i> 초기화
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- User List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-users me-2"></i>사용자 목록</h5>
                <div>
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        <i class="fas fa-plus"></i> 새 사용자
                    </button>
                    <button class="btn btn-info btn-sm" onclick="exportUsers()">
                        <i class="fas fa-download"></i> 내보내기
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if users %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll"></th>
                                    <th>이메일</th>
                                    <th>이름</th>
                                    <th>사용자 유형</th>
                                    <th>구독 티어</th>
                                    <th>조직</th>
                                    <th>상태</th>
                                    <th>가입일</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                    <tr>
                                        <td><input type="checkbox" class="user-checkbox" value="{{ user.id }}"></td>
                                        <td>
                                            <strong>{{ user.email }}</strong>
                                            {% if user.is_superuser %}
                                                <i class="fas fa-crown text-warning ms-1" title="슈퍼 관리자"></i>
                                            {% endif %}
                                        </td>
                                        <td>{{ user.get_full_name|default:"미설정" }}</td>
                                        <td>
                                            <span class="badge bg-{% if user.user_type == 'super_admin' %}danger{% elif user.user_type == 'admin' %}warning{% elif user.user_type == 'enterprise' %}success{% else %}secondary{% endif %}">
                                                {{ user.get_user_type_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if user.subscription_tier == 'unlimited' %}danger{% elif user.subscription_tier == 'enterprise' %}success{% elif user.subscription_tier == 'professional' %}primary{% else %}secondary{% endif %}">
                                                {{ user.get_subscription_tier_display }}
                                            </span>
                                        </td>
                                        <td>{{ user.organization|default:"미설정" }}</td>
                                        <td>
                                            {% if user.is_active %}
                                                <span class="badge bg-success">활성</span>
                                            {% else %}
                                                <span class="badge bg-danger">비활성</span>
                                            {% endif %}
                                            {% if user.is_verified %}
                                                <i class="fas fa-check-circle text-success ms-1" title="인증완료"></i>
                                            {% else %}
                                                <i class="fas fa-exclamation-circle text-warning ms-1" title="미인증"></i>
                                            {% endif %}
                                        </td>
                                        <td>{{ user.created_at|date:"Y-m-d" }}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" 
                                                        onclick="viewUser('{{ user.id }}')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-warning" 
                                                        onclick="editUser('{{ user.id }}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                {% if not user.is_superuser %}
                                                    <button class="btn btn-outline-danger" 
                                                            onclick="deleteUser('{{ user.id }}')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div class="mt-3">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="btn-group">
                                    <button class="btn btn-outline-success" onclick="bulkAction('activate')">
                                        <i class="fas fa-check"></i> 활성화
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="bulkAction('deactivate')">
                                        <i class="fas fa-ban"></i> 비활성화
                                    </button>
                                    <button class="btn btn-outline-info" onclick="bulkAction('verify')">
                                        <i class="fas fa-certificate"></i> 인증
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="bulkAction('upgrade_premium')">
                                        <i class="fas fa-crown"></i> 프리미엄 업그레이드
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <small class="text-muted">총 {{ users|length }}명의 사용자</small>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">사용자를 찾을 수 없습니다.</h5>
                        <p class="text-muted">검색 조건을 변경하거나 새로운 사용자를 추가해보세요.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">새 사용자 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">이메일 *</label>
                                <input type="email" class="form-control" name="email" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">사용자명 *</label>
                                <input type="text" class="form-control" name="username" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">이름</label>
                                <input type="text" class="form-control" name="first_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">성</label>
                                <input type="text" class="form-control" name="last_name">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">비밀번호 *</label>
                                <input type="password" class="form-control" name="password" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">비밀번호 확인 *</label>
                                <input type="password" class="form-control" name="password_confirm" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">사용자 유형</label>
                                <select class="form-select" name="user_type">
                                    {% for value, display in user_types %}
                                        <option value="{{ value }}">{{ display }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">구독 티어</label>
                                <select class="form-select" name="subscription_tier">
                                    {% for value, display in subscription_tiers %}
                                        <option value="{{ value }}">{{ display }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="createUser()">사용자 생성</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Select All Checkbox
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
});

// Export Users
function exportUsers() {
    window.location.href = '/super-admin/api/admin/export-users/';
}

// Bulk Actions
function bulkAction(action) {
    const selectedUsers = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
    
    if (selectedUsers.length === 0) {
        alert('작업할 사용자를 선택해주세요.');
        return;
    }
    
    if (!confirm(`선택된 ${selectedUsers.length}명의 사용자에 대해 ${action} 작업을 수행하시겠습니까?`)) {
        return;
    }
    
    fetch('/super-admin/api/users/bulk-action/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            user_ids: selectedUsers,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('오류가 발생했습니다: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('서버 오류가 발생했습니다.');
    });
}

// User Actions
function viewUser(userId) {
    // Implement user view modal
    alert('사용자 상세 보기 기능을 구현 중입니다.');
}

function editUser(userId) {
    // Implement user edit modal
    alert('사용자 수정 기능을 구현 중입니다.');
}

function deleteUser(userId) {
    if (confirm('정말로 이 사용자를 삭제하시겠습니까?')) {
        // Implement user deletion
        alert('사용자 삭제 기능을 구현 중입니다.');
    }
}

// Create User
function createUser() {
    const form = document.getElementById('addUserForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    fetch('/super-admin/api/users/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            alert('사용자가 성공적으로 생성되었습니다.');
            location.reload();
        } else {
            alert('오류가 발생했습니다: ' + JSON.stringify(data));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('서버 오류가 발생했습니다.');
    });
}

// CSRF Token Helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}